<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'Authentification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .success {
            color: green;
            margin-top: 5px;
        }
        .section {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
        }
        .log {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Test d'Authentification</h1>

    <div class="section">
        <h2>Test de Connexion API</h2>
        <button id="test-api">Tester l'API v2</button>
        <div id="api-result" class="log"></div>
    </div>

    <div class="section">
        <h2>Inscription</h2>
        <form id="register-form">
            <div class="form-group">
                <label for="register-username">Nom d'utilisateur :</label>
                <input type="text" id="register-username" required>
            </div>
            <div class="form-group">
                <label for="register-password">Mot de passe :</label>
                <input type="password" id="register-password" required>
            </div>
            <div class="form-group">
                <label for="register-confirm-password">Confirmer le mot de passe :</label>
                <input type="password" id="register-confirm-password" required>
            </div>
            <button type="submit">S'inscrire</button>
            <button id="register-url-btn" style="margin-top: 10px;">S'inscrire via URL (méthode alternative)</button>
        </form>
        <div id="register-result" class="log"></div>
    </div>

    <div class="section">
        <h2>Connexion</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="login-username">Nom d'utilisateur :</label>
                <input type="text" id="login-username" required>
            </div>
            <div class="form-group">
                <label for="login-password">Mot de passe :</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit">Se connecter</button>
        </form>
        <div id="login-result" class="log"></div>
    </div>

    <div class="section">
        <h2>Logs</h2>
        <button id="clear-logs">Effacer les logs</button>
        <div id="debug-log" class="log"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration
            const API_URL = 'http://localhost:3000/api';
            
            // Éléments DOM
            const testApiBtn = document.getElementById('test-api');
            const apiResult = document.getElementById('api-result');
            const registerForm = document.getElementById('register-form');
            const registerResult = document.getElementById('register-result');
            const loginForm = document.getElementById('login-form');
            const loginResult = document.getElementById('login-result');
            const debugLog = document.getElementById('debug-log');
            const clearLogsBtn = document.getElementById('clear-logs');
            
            // Fonction utilitaire pour les logs
            function log(message, logElement = debugLog) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
                logElement.appendChild(logEntry);
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            // Test de l'API
            testApiBtn.addEventListener('click', async function() {
                log('Tentative de connexion à l\'API...', apiResult);
                
                try {
                    // Test simple pour voir si le serveur répond
                    const response = await fetch(`${API_URL}/test`);
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    log(`✅ API accessible! Réponse: ${JSON.stringify(data)}`, apiResult);
                    log('Test API réussi');
                } catch (error) {
                    log(`❌ Erreur API: ${error.message}`, apiResult);
                    log(`Erreur lors du test API: ${error.message}`);
                }
            });
            
            // Inscription
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;

                // Vérification côté client
                if (password !== confirmPassword) {
                    log('❌ Les mots de passe ne correspondent pas', registerResult);
                    return;
                }

                log(`Tentative d'inscription pour l'utilisateur: ${username}...`, registerResult);

                try {
                    // Créer explicitement un objet pour le corps de la requête
                    const requestData = {
                        username: username,
                        password: password
                    };

                    log(`Données à envoyer: ${JSON.stringify(requestData)}`, registerResult);

                    const response = await fetch(`${API_URL}/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    const text = await response.text();
                    log(`Réponse brute du serveur: ${text}`, registerResult);

                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        throw new Error('Réponse non-JSON reçue du serveur');
                    }

                    if (!response.ok) {
                        throw new Error(data.error || 'Erreur d\'inscription');
                    }

                    log(`✅ Inscription réussie: ${data.message || 'Utilisateur créé'}`, registerResult);
                    log(`Inscription réussie pour ${username}`);

                    // Réinitialiser le formulaire
                    registerForm.reset();
                } catch (error) {
                    log(`❌ Erreur: ${error.message}`, registerResult);
                    log(`Erreur lors de l'inscription: ${error.message}`);
                }
            });
            
            // Connexion
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                log(`Tentative de connexion pour l'utilisateur: ${username}...`, loginResult);
                
                try {
                    const response = await fetch(`${API_URL}/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username,
                            password
                        })
                    });
                    
                    const text = await response.text();
                    log(`Réponse brute du serveur: ${text}`, loginResult);
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        throw new Error('Réponse non-JSON reçue du serveur');
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Erreur de connexion');
                    }
                    
                    log(`✅ Connexion réussie! Utilisateur: ${data.user?.username || username}`, loginResult);
                    log(`Connexion réussie pour ${username}`);
                    
                    // Réinitialiser le formulaire
                    loginForm.reset();
                } catch (error) {
                    log(`❌ Erreur: ${error.message}`, loginResult);
                    log(`Erreur lors de la connexion: ${error.message}`);
                }
            });
            
            // Effacer les logs
            clearLogsBtn.addEventListener('click', function() {
                debugLog.innerHTML = '';
                log('Logs effacés');
            });
            
            // Message initial
            log('Page de test d\'authentification chargée.');
            document.getElementById('register-url-btn').addEventListener('click', async function() {
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (password !== confirmPassword) {
                    log('❌ Les mots de passe ne correspondent pas', registerResult);
                    return;
                }
                
                log(`Tentative d'inscription via URL pour: ${username}...`, registerResult);
                
                try {
                    const response = await fetch(`${API_URL}/register-url?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                    
                    const text = await response.text();
                    log(`Réponse brute du serveur: ${text}`, registerResult);
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        throw new Error('Réponse non-JSON reçue du serveur');
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Erreur d\'inscription');
                    }
                    
                    log(`✅ Inscription réussie: ${data.message || 'Utilisateur créé'}`, registerResult);
                    log(`Inscription réussie pour ${username}`);
                    
                    // Réinitialiser le formulaire
                    registerForm.reset();
                } catch (error) {
                    log(`❌ Erreur: ${error.message}`, registerResult);
                    log(`Erreur lors de l'inscription: ${error.message}`);
                }
            });
        });
    </script>
</body>
</html>
